{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="/LTIM_logo.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BRD Generation</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      background: linear-gradient(to right, rgb(21, 90, 186), rgb(230, 209, 29));
      padding: 20px;
    }
    .form-section {
      background-color: #ffffff;
      padding: 40px;
      border-radius: 10px;
      max-width: 1000px;
      margin: 0 auto;
      text-align: center;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      margin-top: 30px;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #1976d2;
      color: white;
    }
    .download-btn {
      margin-top: 20px;
      padding: 10px 24px;
      background-color: #388e3c;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    /* Spinner Styles */
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #1976d2;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>

  <!-- jsPDF & html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>

  <div style="text-align:center; margin-bottom: 30px;">
    <img src="{% static 'images/logo.png' %}" alt="Logo" height="50">
  </div>

  <div class="form-section">
    <h2 style="color: #1a237e; margin-bottom: 30px;">üìÑ BRD Generator</h2>

    <!-- Upload Form -->
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input 
        type="file" 
        name="brd_pdf" 
        accept="application/pdf"
        required
        style="display: block; margin: 0 auto 20px auto; padding: 10px; border: 2px dashed #ccc; border-radius: 10px; background-color: #fff; max-width: 400px; width: 100%;"
      />
      <button 
        type="submit" 
        id="submit-btn"
        style="padding: 10px 24px; background-color: #1976d2; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;"
      >
        Submit
      </button>

      <!-- Spinner (Initially hidden) -->
      <div id="loading-spinner" style="display: none; margin-top: 20px;">
        <div class="loader"></div>
        <p style="color: #444;">Processing... Please wait.</p>
      </div>
    </form>

    {% if uploaded_file_name %}
      <p style="margin-top: 20px;">‚úÖ Uploaded: <strong>{{ uploaded_file_name }}</strong></p>
    {% endif %}

    {% if requirements %}
      <h3 style="margin-top: 40px;">üìã Extracted Requirements</h3>

      <!-- Download Button -->
      <button class="download-btn" onclick="downloadTableAsPDF()">‚¨áÔ∏è Download Table as PDF</button>

      <!-- Table Container -->
      <div id="requirement-table" style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Section</th>
              <th>ID</th>
              <th>Description</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody>
            {% for req in requirements %}
            <tr>
              <td>{{ req.section }}</td>
              <td>{{ req.id }}</td>
              <td>{{ req.description|safe }}</td>
              <td>{{ req.type }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  <!-- JS to Download as PDF -->
  <script>
    async function downloadTableAsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'a4');
      const element = document.getElementById('requirement-table');

      await html2canvas(element, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pageWidth = doc.internal.pageSize.getWidth();
        const imgProps = doc.getImageProperties(imgData);
        const imgHeight = (imgProps.height * pageWidth) / imgProps.width;

        doc.addImage(imgData, 'PNG', 0, 20, pageWidth, imgHeight);
        doc.save("BRD_Requirements.pdf");
      });
    }

    // Show spinner on form submit
    const form = document.querySelector("form");
    const submitBtn = document.getElementById("submit-btn");
    const spinner = document.getElementById("loading-spinner");

    form.addEventListener("submit", function () {
      submitBtn.disabled = true;
      spinner.style.display = "block";
    });
  </script>
</body>
</html>
